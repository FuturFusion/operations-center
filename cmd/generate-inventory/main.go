package main

import (
	"bytes"
	"embed"
	"go/format"
	"os"
	"strings"
	"text/template"

	"github.com/Masterminds/sprig/v3"
	"github.com/spf13/pflag"
)

//go:embed tmpl
var templateFS embed.FS

const generatedByPreamble = `// Code generated by generate-inventory; DO NOT EDIT.

`

func main() {
	pluralName := pflag.String("plural", "", "plural form of the entity")
	objectNamePropertyName := pflag.String("object-name-property-name", "Name", "Name property of the object")
	objectType := pflag.String("object-type", "", "Go type used for object in model")
	omitProject := pflag.Bool("omit-project", false, "if omit-project is provided, the entity does not have a relation to a project")
	usesEmbeddedPostType := pflag.Bool("uses-embedded-post-type", false, "if uses-embedded-post-type is provided, the name property is part of an embedded Post type")
	incusGetMethod := pflag.String("incus-get-method", "", "method of the Incus client to get the entities, e.g. GetStoragePoolBucketsAllProjects")
	parentName := pflag.String("parent", "", "name of the parent entity, if any")
	parentPluralName := pflag.String("parent-plural", "", "plural form of the parent entity")
	parentObjectType := pflag.String("parent-object-type", "", "Go type used for object in model for the parent entity")
	pflag.Parse()

	name := pflag.Args()[0]
	objectEmbedded := false

	if *pluralName == "" {
		*pluralName = name + "s"
	}

	if *objectType != "" {
		objectEmbedded = true
	}

	if *objectType == "" {
		*objectType = name
	}

	if *parentPluralName == "" {
		*parentPluralName = *parentName + "s"
	}

	if *parentObjectType == "" {
		*parentObjectType = *parentName
	}

	targets := []struct {
		TemplateName string
		TargetName   string
	}{
		{
			TemplateName: "api.gotmpl",
			TargetName:   "cmd/operations-centerd/internal/api/api_inventory_{{ .Name }}.go",
		},
		{
			TemplateName: "model.gotmpl",
			TargetName:   "internal/inventory/{{ .Name }}_model.go",
		},
		{
			TemplateName: "ports.gotmpl",
			TargetName:   "internal/inventory/{{ .Name }}_ports.go",
		},
		{
			TemplateName: "repo_incus.gotmpl",
			TargetName:   "internal/inventory/repo/incus/{{ .Name }}.go",
		},
		{
			TemplateName: "repo_sqlite_test.gotmpl",
			TargetName:   "internal/inventory/repo/sqlite/{{ .Name }}_test.go",
		},
		{
			TemplateName: "repo_sqlite.gotmpl",
			TargetName:   "internal/inventory/repo/sqlite/{{ .Name }}.go",
		},
		{
			TemplateName: "service_internal_test.gotmpl",
			TargetName:   "internal/inventory/{{ .Name }}_service_internal_test.go",
		},
		{
			TemplateName: "service_test.gotmpl",
			TargetName:   "internal/inventory/{{ .Name }}_service_test.go",
		},
		{
			TemplateName: "service.gotmpl",
			TargetName:   "internal/inventory/{{ .Name }}_service.go",
		},
		{
			TemplateName: "shared_api.gotmpl",
			TargetName:   "shared/api/inventory_{{ .Name }}.go",
		},
	}

	var err error

	funcsMap := sprig.FuncMap()
	funcsMap["pascalcase"] = PascalCase
	funcsMap["camelcase"] = CamelCase

	t := template.New("")
	t = t.Funcs(funcsMap)
	t, err = t.ParseFS(templateFS, "tmpl/*.gotmpl")
	die(err)

	args := struct {
		Name                   string
		PluralName             string
		ObjectType             string
		ObjectEmbedded         bool
		ObjectNamePropertyName string
		HasProject             bool
		UsesEmbeddedPostType   bool
		IncusGetMethod         string
		HasParent              bool
		ParentName             string
		ParentPluralName       string
		ParentObjectType       string
	}{
		Name:                   name,
		PluralName:             *pluralName,
		ObjectType:             *objectType,
		ObjectEmbedded:         objectEmbedded,
		ObjectNamePropertyName: *objectNamePropertyName,
		HasProject:             !*omitProject,
		UsesEmbeddedPostType:   *usesEmbeddedPostType,
		IncusGetMethod:         *incusGetMethod,
		HasParent:              *parentName != "",
		ParentName:             *parentName,
		ParentPluralName:       *parentPluralName,
		ParentObjectType:       *parentObjectType,
	}

	for _, target := range targets {
		func() {
			filename := strings.Builder{}

			filenameTmpl, err := template.New("name").Funcs(funcsMap).Parse(target.TargetName)
			die(err)

			err = filenameTmpl.Execute(&filename, args)
			die(err)

			buf := bytes.Buffer{}

			_, err = buf.WriteString(generatedByPreamble)
			die(err)

			err = t.ExecuteTemplate(&buf, target.TemplateName, args)
			die(err)

			formattedSource, err := format.Source(buf.Bytes())
			die(err)

			err = os.WriteFile(filename.String(), formattedSource, 0o600)
			die(err)
		}()
	}
}

func die(err error) {
	if err != nil {
		panic(err)
	}
}

// Code generated by generate-inventory; DO NOT EDIT.

package api

import (
	"fmt"
	"net/http"
	"strconv"

	"github.com/google/uuid"

	"github.com/FuturFusion/operations-center/internal/authz"
	"github.com/FuturFusion/operations-center/internal/inventory"
	"github.com/FuturFusion/operations-center/internal/util/ptr"
	"github.com/FuturFusion/operations-center/internal/util/response"
	"github.com/FuturFusion/operations-center/shared/api"
)

type storageBucketHandler struct {
	service inventory.StorageBucketService
}

func registerInventoryStorageBucketHandler(router Router, authorizer *authz.Authorizer, service inventory.StorageBucketService) {
	handler := &storageBucketHandler{
		service: service,
	}

	router.HandleFunc("GET /{$}", response.With(handler.storageBucketsGet, assertPermission(authorizer, authz.ObjectTypeServer, authz.EntitlementCanView)))
	router.HandleFunc("GET /{uuid}", response.With(handler.storageBucketGet, assertPermission(authorizer, authz.ObjectTypeServer, authz.EntitlementCanView)))
	router.HandleFunc("POST /{uuid}/:resync", response.With(handler.storageBucketResyncPost, assertPermission(authorizer, authz.ObjectTypeServer, authz.EntitlementCanEdit)))
}

// swagger:operation GET /1.0/inventory/storage_buckets storage_buckets storage_buckets_get
//
//	Get the storage_buckets
//
//	Returns a list of storage buckets (list of relative URLs).
//
//	---
//	produces:
//	  - application/json
//	parameters:
//	  - in: query
//	    name: cluster
//	    description: Cluster name
//	    type: string
//	    example: cluster
//	  - in: query
//	    name: server
//	    description: Server name
//	    type: string
//	    example: localhost
//	  - in: query
//	    name: project
//	    description: Project name
//	    type: string
//	    example: default
//	  - in: query
//	    name: filter
//	    description: Filter expression
//	    type: string
//	    example: name == "value"
//	responses:
//	  "200":
//	    description: API storage buckets
//	    schema:
//	      type: object
//	      description: Sync response
//	      properties:
//	        type:
//	          type: string
//	          description: Response type
//	          example: sync
//	        status:
//	          type: string
//	          description: Status description
//	          example: Success
//	        status_code:
//	          type: integer
//	          description: Status code
//	          example: 200
//	        metadata:
//	          type: array
//	          description: List of storage buckets
//	          items:
//	            type: string
//	          example: |-
//	            [
//	              "/1.0/inventory/storage_buckets/1",
//	              "/1.0/inventory/storage_buckets/2"
//	            ]
//	  "403":
//	    $ref: "#/responses/Forbidden"
//	  "500":
//	    $ref: "#/responses/InternalServerError"

// swagger:operation GET /1.0/inventory/storage_buckets?recursion=1 storage_buckets storage_buckets_get_recursion
//
//	Get the storage buckets
//
//	Returns a list of storage buckets (structs).
//
//	---
//	produces:
//	  - application/json
//	parameters:
//	  - in: query
//	    name: cluster
//	    description: Cluster name
//	    type: string
//	    example: cluster
//	  - in: query
//	    name: server
//	    description: Server name
//	    type: string
//	    example: localhost
//	  - in: query
//	    name: project
//	    description: Project name
//	    type: string
//	    example: default
//	  - in: query
//	    name: filter
//	    description: Filter expression
//	    type: string
//	    example: name == "value"
//	responses:
//	  "200":
//	    description: API storage buckets
//	    schema:
//	      type: object
//	      description: Sync response
//	      properties:
//	        type:
//	          type: string
//	          description: Response type
//	          example: sync
//	        status:
//	          type: string
//	          description: Status description
//	          example: Success
//	        status_code:
//	          type: integer
//	          description: Status code
//	          example: 200
//	        metadata:
//	          type: array
//	          description: List of storage buckets
//	          items:
//	            $ref: "#/definitions/storageBucket"
//	  "403":
//	    $ref: "#/responses/Forbidden"
//	  "500":
//	    $ref: "#/responses/InternalServerError"
func (i *storageBucketHandler) storageBucketsGet(r *http.Request) response.Response {
	// Parse the recursion field.
	recursion, err := strconv.Atoi(r.FormValue("recursion"))
	if err != nil {
		recursion = 0
	}

	var filter inventory.StorageBucketFilter

	if r.URL.Query().Get("cluster") != "" {
		filter.Cluster = ptr.To(r.URL.Query().Get("cluster"))
	}

	if r.URL.Query().Get("server") != "" {
		filter.Server = ptr.To(r.URL.Query().Get("server"))
	}

	if r.URL.Query().Get("project") != "" {
		filter.ProjectName = ptr.To(r.URL.Query().Get("project"))
	}

	if r.URL.Query().Get("filter") != "" {
		filter.Expression = ptr.To(r.URL.Query().Get("filter"))
	}

	if recursion == 1 {
		// FIXME: Should we require a non empty filter with recursion?
		storageBuckets, err := i.service.GetAllWithFilter(r.Context(), filter)
		if err != nil {
			return response.SmartError(err)
		}

		result := make([]api.StorageBucket, 0, len(storageBuckets))
		for _, storageBucket := range storageBuckets {
			result = append(result, api.StorageBucket{
				UUID:            storageBucket.UUID,
				Cluster:         storageBucket.Cluster,
				Server:          ptr.From(storageBucket.Server),
				ProjectName:     storageBucket.ProjectName,
				StoragePoolName: storageBucket.StoragePoolName,
				Name:            storageBucket.Name,
				Object:          storageBucket.Object.StorageBucketFull,
				LastUpdated:     storageBucket.LastUpdated,
			})
		}

		return response.SyncResponse(true, result)
	}

	storageBucketUUIDs, err := i.service.GetAllUUIDsWithFilter(r.Context(), filter)
	if err != nil {
		return response.SmartError(err)
	}

	result := make([]string, 0, len(storageBucketUUIDs))
	for _, id := range storageBucketUUIDs {
		result = append(result, fmt.Sprintf("/%s/inventory/storage_bucket/%s", api.APIVersion, id.String()))
	}

	return response.SyncResponse(true, result)
}

// swagger:operation GET /1.0/inventory/storage_buckets/{uuid} storage_buckets storage_bucket_get
//
//	Get the storage bucket
//
//	Gets a specific storage bucket.
//
//	---
//	produces:
//	  - application/json
//	responses:
//	  "200":
//	    description: storage bucket
//	    schema:
//	      type: object
//	      description: Sync response
//	      properties:
//	        type:
//	          type: string
//	          description: Response type
//	          example: sync
//	        status:
//	          type: string
//	          description: Status description
//	          example: Success
//	        status_code:
//	          type: integer
//	          description: Status code
//	          example: 200
//	        metadata:
//	          $ref: "#/definitions/StorageBucket"
//	  "403":
//	    $ref: "#/responses/Forbidden"
//	  "500":
//	    $ref: "#/responses/InternalServerError"
func (i *storageBucketHandler) storageBucketGet(r *http.Request) response.Response {
	id, err := uuid.Parse(r.PathValue("uuid"))
	if err != nil {
		return response.SmartError(err)
	}

	storageBucket, err := i.service.GetByUUID(r.Context(), id)
	if err != nil {
		return response.SmartError(err)
	}

	return response.SyncResponse(
		true,
		api.StorageBucket{
			UUID:            storageBucket.UUID,
			Cluster:         storageBucket.Cluster,
			Server:          ptr.From(storageBucket.Server),
			ProjectName:     storageBucket.ProjectName,
			StoragePoolName: storageBucket.StoragePoolName,
			Name:            storageBucket.Name,
			Object:          storageBucket.Object.StorageBucketFull,
			LastUpdated:     storageBucket.LastUpdated,
		},
	)
}

// swagger:operation POST /1.0/inventory/storage_buckets/{uuid}/:resync storage_buckets storage_bucket_get_resync_post
//
//	Resync the storage bucket
//
//	Resync a specific storage bucket.
//
//	---
//	produces:
//	  - application/json
//	responses:
//	  "200":
//	    description: Empty response
//	    schema:
//	      type: object
//	      description: Sync response
//	      properties:
//	        type:
//	          type: string
//	          description: Response type
//	          example: sync
//	        status:
//	          type: string
//	          description: Status description
//	          example: Success
//	        status_code:
//	          type: integer
//	          description: Status code
//	          example: 200
//	  "403":
//	    $ref: "#/responses/Forbidden"
//	  "500":
//	    $ref: "#/responses/InternalServerError"
func (i *storageBucketHandler) storageBucketResyncPost(r *http.Request) response.Response {
	id, err := uuid.Parse(r.PathValue("uuid"))
	if err != nil {
		return response.SmartError(err)
	}

	err = i.service.ResyncByUUID(r.Context(), id)
	if err != nil {
		return response.SmartError(fmt.Errorf("Failed to resync storage_bucket: %w", err))
	}

	return response.EmptySyncResponse
}
